/*!
 * Titon Toolkit v1.1.0-rc.1
 * Copyright 2010-2013, The Titon Project - http://titon.io
 * BSD-2 - https://github.com/titon/toolkit/blob/master/license.md
 */
!function(a){"use strict";Toolkit.Matrix=Toolkit.Component.create(function(a,b){this.component="Matrix",this.version="0.0.0",this.options=this.setOptions(Toolkit.Matrix.options,b),this.element=this.setElement(a,this.options),this.items=[],this.matrix=[],this.wrapperWidth=0,this.colWidth=0,this.colCount=0,this.images=[],this.imagesLoaded=0,this.initialize()}),Toolkit.Matrix.options={className:"",selector:".matrix-item",width:200,gutter:20,rtl:!1,defer:!0,template:!1};var b=Toolkit.Matrix.prototype;b.initialize=function(){this.element.addClass(Toolkit.options.vendor+"matrix"),this.items=this.element.find(this.options.selector),a(window).on("resize",a.debounce(this.__resize.bind(this))),this.fireEvent("init"),this.options.defer?this._deferRender():this.render()},b.append=function(b){return a(b).addClass(Toolkit.options.vendor+"matrix-item").appendTo(this.element).css("opacity",0),this.refresh()},b.disable=function(){return this.enabled=!1,this.element.removeAttr("style"),this.items.removeClass(Toolkit.options.vendor+"matrix-item").removeAttr("style"),this},b.enable=function(){return this.enabled=!0,this.items.addClass(Toolkit.options.vendor+"matrix-item"),this},b.prepend=function(b){return a(b).addClass(Toolkit.options.vendor+"matrix-item").prependTo(this.element).css("opacity",0),this.refresh()},b.refresh=function(){return this.items=this.element.find(this.options.selector),this.render()},b.remove=function(b){return b=a(b).get(0),this.items.each(function(){var c=a(this);return c.get(0)===b?(c.remove(),!1):!0}),this.refresh()},b.render=function(){return this._calculateColumns(),this.items.length<this.colCount?this.disable():(this.enable(),this.colCount<=1?(this.element.addClass("no-columns"),this.items.removeAttr("style")):(this.element.removeClass("no-columns"),this._organizeItems(),this._positionItems()),this.fireEvent("render"),this)},b._calculateColumns=function(){var a,b=this.element.outerWidth(),c=this.options.width,d=this.options.gutter,e=Math.max(Math.floor(b/c),1),f=e*(c+d)-d;return e>1&&(f>b?(a=f-b,c-=a/e):b>f&&(a=b-f,c+=a/e)),this.wrapperWidth=b,this.colWidth=c,this.colCount=e,this},b._deferRender=function(){return this.imagesLoaded=0,this.images=this.element.find("img"),this.images.length?this.images.each(function(a,b){var c=b.src;b.onload=this.__load.bind(this),b.onerror=this.__load.bind(this),b.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",b.src=c}.bind(this)):this.render(),this},b._organizeItems=function(){var a,b,c,d=0,e=this.items.length;this.matrix=[];for(var f=0;e>f;f++){if(a=this.items.item(f),c=a.outerWidth(),b=Math.max(Math.round(c/this.colWidth),1),this.matrix.push({item:a,span:b}),b>1)for(var g=1;b>g;g++)d++,this.matrix&&this.matrix.push({item:a,span:!1});d++,d>=this.colCount&&(d=0)}return this},b._positionItems=function(){var a,b,c,d,e,f,g=this.options.gutter,h=this.matrix,i=this.options.rtl?"right":"left",j=0,k=[],l=0,m={margin:0,position:"absolute"};for(d=0;d<this.colCount;d++)k.push(0);for(d=0,e=h.length;e>d;d++){if(a=h[d],b=a.span,(l>=this.colCount||b+l>this.colCount)&&(l=0,j=0),b){for(c=0,f=0;b>f;f++)k[l+f]>c&&(c=k[l+f]);for(m.top=c,m[i]=j,m.width=(this.colWidth+g)*b-g,a.item.css(m).reveal(),f=0;b>f;f++)k[l+f]=a.item.outerHeight()+g+c}j+=this.colWidth+g,l++}return this.element.css("height",Math.max.apply(Math,k)),this},b.__load=function(a){(!a||"load"===a.type&&a.target.complete||"error"===a.type&&!a.target.complete)&&this.imagesLoaded++,this.imagesLoaded===this.images.length&&this.render()},b.__resize=function(){this.element.hasClass(Toolkit.options.vendor+"matrix")&&this.refresh()},Toolkit.createComponent("matrix",function(a){return new Toolkit.Matrix(this,a)})}(jQuery);