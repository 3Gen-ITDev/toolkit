/*!
 * Titon Toolkit v1.0.0-rc.3
 * Copyright 2010-2013, The Titon Project - http://titon.io
 * BSD-2 - https://github.com/titon/toolkit/blob/master/license.md
 */
!function(a){"use strict";Toolkit.Matrix=Toolkit.Component.create(function(b,c){this.options=this.setOptions(Toolkit.Matrix.options,c),this.element=this.setElement(b,this.options),this.items=[],this.matrix=[],this.wrapperWidth=0,this.colWidth=0,this.colCount=0,this.images=[],this.imagesLoaded=0,this.initialize=function(){this.element.addClass("matrix"),this.items=this.element.find(this.options.selector),a(window).on("resize",a.debounce(this.__resize.bind(this))),this.fireEvent("init"),this.options.defer?this._deferRender():this.render()},this.append=function(b){return a(b).addClass("matrix-item").appendTo(this.element).css("opacity",0),this.refresh()},this.disable=function(){return this.element.removeProperty("style"),this.items.removeClass("matrix-item").removeProperty("style"),this},this.enable=function(){return this.items.addClass("matrix-item"),this},this.prepend=function(b){return a(b).addClass("matrix-item").prependTo(this.element).css("opacity",0),this.refresh()},this.refresh=function(){return this.items=this.element.find(this.options.selector),this.render()},this.remove=function(b){return b=a(b).get(0),this.items.each(function(){var c=a(this);return c.get(0)===b?(c.remove(),!1):!0}),this.refresh()},this.render=function(){return this._calculateColumns(),this.items.length<this.colCount?this.disable():(this.enable(),this.colCount<=1?(this.element.addClass("no-columns"),this.items.removeAttr("style")):(this.element.removeClass("no-columns"),this._organizeItems(),this._positionItems()),this.fireEvent("render"),this)},this._calculateColumns=function(){var a,b=this.element.outerWidth(),c=this.options.width,d=this.options.gutter,e=Math.max(Math.floor(b/c),1),f=e*(c+d)-d;return e>1&&(f>b?(a=f-b,c-=a/e):b>f&&(a=b-f,c+=a/e)),this.wrapperWidth=b,this.colWidth=c,this.colCount=e,this},this._deferRender=function(){return this.imagesLoaded=0,this.images=this.element.find("img"),this.images.each(function(a,b){var c=b.src;b.onload=this.__load.bind(this),b.onerror=this.__load.bind(this),b.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",b.src=c}.bind(this)),this},this._organizeItems=function(){var b,c,d,e=0,f=this.items.length;this.matrix=[];for(var g=0;f>g;g++){if(b=a(this.items[g]),d=b.outerWidth(),c=Math.max(Math.round(d/this.colWidth),1),this.matrix.push({item:b,span:c}),c>1)for(var h=1;c>h;h++)e++,this.matrix&&this.matrix.push({item:b,span:!1});e++,e>=this.colCount&&(e=0)}return this},this._positionItems=function(){var a,b,c,d,e,f,g=this.options.gutter,h=this.matrix,i=this.options.rtl?"right":"left",j=0,k=[],l=0,m={margin:0,position:"absolute"};for(d=0;d<this.colCount;d++)k.push(0);for(d=0,e=h.length;e>d;d++){if(a=h[d],b=a.span,(l>=this.colCount||b+l>this.colCount)&&(l=0,j=0),b){for(c=0,f=0;b>f;f++)k[l+f]>c&&(c=k[l+f]);for(m.top=c,m[i]=j,m.width=(this.colWidth+g)*b-g,a.item.css(m).reveal(),f=0;b>f;f++)k[l+f]=a.item.outerHeight()+g+c}j+=this.colWidth+g,l++}return this.element.css("height",Math.max.apply(Math,k)),this},this.__load=function(a){(!a||"load"===a.type&&a.target.complete||"error"===a.type&&!a.target.complete)&&this.imagesLoaded++,this.imagesLoaded===this.images.length&&this.render()},this.__resize=function(){this.element.hasClass("matrix")&&this.refresh()},this.element.length&&this.initialize()}),Toolkit.Matrix.options={className:"",selector:".matrix-item",width:200,gutter:20,rtl:!1,defer:!0,template:!1},a.fn.matrix=function(a){return this.each(function(){this.$matrix||(this.$matrix=new Toolkit.Matrix(this,a))})}}(jQuery);