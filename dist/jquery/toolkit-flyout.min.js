/*!
 * Titon Toolkit v1.0.5
 * Copyright 2010-2013, The Titon Project - http://titon.io
 * BSD-2 - https://github.com/titon/toolkit/blob/master/license.md
 */
!function(a){"use strict";Toolkit.Flyout=Toolkit.Component.create(function(b,c,d){this.options=this.setOptions(Toolkit.Flyout.options,d),this.nodes=a(b),this.node=null,this.element=null,this.current=null,this.menus={},this.data=[],this.dataMap={},this.timers={},this.enabled=!0,this.initialize=function(){if(!c)throw new Error("Flyout URL required to download sitemap JSON");a.ajax({url:c,dataType:"json",success:this.load.bind(this)});var b=this.options;"hover"===b.mode&&a(b.context||document).on("mouseenter",this.nodes.selector,function(){this.clearTimer("hide").startTimer("show",b.showDelay)}.bind(this)).on("mouseleave",this.nodes.selector,function(){this.clearTimer("show").startTimer("hide",b.showDelay)}.bind(this)),a(b.context||document).on("click"===b.mode?"click":"mouseenter",this.nodes.selector,this.__show.bind(this)),this.fireEvent("init")},this.clearTimer=function(a){return window.clearTimeout(this.timers[a]),delete this.timers[a],this},this.hide=function(){return this.node.removeClass(Toolkit.options.isPrefix+"active"),this.current&&this.isVisible()?(this.menus[this.current].conceal(),this.fireEvent("hide"),this.current=null,this):this},this.isVisible=function(){return this.current&&this.menus[this.current]&&(this.element=this.menus[this.current]),this.element&&this.element.is(":shown")},this.load=function(a,b){if(b=b||0,0===b&&(this.data=a),this.dataMap[a.url]=a,a.children)for(var c=0,d=a.children.length;d>c;c++)this.load(a.children[c],b+1);return this},this.position=function(){var b=this.current,c=this.options;if(!this.menus[b])return this;var d=this.menus[b],e=d.outerHeight(),f=this.node.offset(),g=f.left+c.xOffset,h=f.top+c.yOffset+this.node.outerHeight(),i=a(window).height();return h>i/2&&(h=f.top-c.yOffset-e),d.css({left:g,top:h}).reveal(),this.fireEvent("show"),this},this.show=function(b){var c=this._getTarget(b);return this.current&&c!==this.current&&(this.hide(),this.startTimer("show",this.options.showDelay)),this.node=a(b),this._getMenu()?(this.fireEvent("load",b),this.node.addClass(Toolkit.options.isPrefix+"active"),"click"===this.options.mode&&this.position(),this):this},this.startTimer=function(a,b,c){this.clearTimer(a);var d;return d="show"===a?this.position.bind(this):this.hide.bind(this),d&&(this.timers[a]=window.setTimeout(function(){d.apply(this,c||[])}.bind(this),b)),this},this._buildMenu=function(b,c){if(!c.children||!c.children.length)return null;var d,e,f,g=a(this.options.template),h=[],i=this.options.contentElement,j=this.options.itemLimit;this.options.className&&g.addClass(this.options.className),b.is("body")&&g.addClass(Toolkit.options.isPrefix+"root"),j&&c.children.length>j?h=c.children.chunk(j):h.push(c.children);for(var k,l=0;k=h[l];l++){d=a("<ul/>");for(var m,n=0,o=k.length;o>n;n++)m=k[n],e=a("<li/>"),m.url?(f=a("<a/>",{text:m.title,href:m.url}),a("<span/>").addClass(m.icon||"caret-right").prependTo(f)):(f=a("<span/>",{text:m.title}),e.addClass(Toolkit.options.vendor+"flyout-heading")),m.attributes&&f.attr(m.attributes),m.className&&e.addClass(m.className),e.append(f).appendTo(d),m.children&&m.children.length&&(this._buildMenu(e,m),e.addClass(Toolkit.options.hasPrefix+"children").on("mouseenter",this.__positionChild.bind(this,e)).on("mouseleave",this.__hideChild.bind(this,e)));i?"."===i.substr(0,1)&&g.hasClass(i.substr(1))?g.append(d):g.find(i).append(d):g.append(d)}return g.appendTo(b),g},this._getMenu=function(){var b=this._getTarget();if(this.menus[b])return this.current=b,this.menus[b];if(this.dataMap[b]){var c=this._buildMenu(a("body"),this.dataMap[b]);return c?(c.conceal(),"hover"===this.options.mode&&c.on({mouseenter:function(){this.clearTimer("hide")}.bind(this),mouseleave:function(){this.startTimer("hide",this.options.hideDelay)}.bind(this)}),this.current=b,this.menus[b]=c,this.menus[b]):null}return null},this._getTarget=function(b){return b=a(b||this.node),this.readValue(b,this.options.getUrl)||b.attr("href")},this.__hideChild=function(b){b=a(b),b.removeClass(Toolkit.options.isPrefix+"open"),b.children(this.options.contentElement).removeAttr("style"),this.fireEvent("hideChild",b)},this.__positionChild=function(b){var c=b.children(this.options.contentElement);if(c){var d=c.children();c.css("width",d.outerWidth()*d.length+"px");var e=a(window),f=e.height()+e.scrollTop(),g=e.width(),h=b.offset().top,i=b.outerHeight(),j=b.offset().left+b.outerWidth(),k=j+c.outerWidth();k>=g?c.addClass("push-left"):c.removeClass("push-left"),h>f/2?c.css("top","-"+(c.outerHeight()-i)+"px"):c.css("top",0),b.addClass(Toolkit.options.isPrefix+"open"),this.fireEvent("showChild",b)}},this.__show=function(b){var c=a(b.target),d=this.node&&c[0]===this.node[0];if(this.isVisible()){if(Toolkit.isTouch?d&&"a"===this.node.prop("tagName").toLowerCase()||b.preventDefault():b.preventDefault(),"click"===this.options.mode&&this.hide(),d)return}else b.preventDefault();this.show(c)},this.initialize()}),Toolkit.Flyout.options={className:"",context:null,mode:"hover",getUrl:"href",xOffset:0,yOffset:0,showDelay:350,hideDelay:1e3,itemLimit:15,contentElement:".flyout",template:'<div class="flyout"></div>'},a.fn.flyout=function(b,c){var d=new Toolkit.Flyout(this,b,c);return this.each(function(){a(this).addData("toolkit.flyout",d)})}}(jQuery);