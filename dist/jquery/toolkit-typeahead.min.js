/*!
 * Titon Toolkit v1.1.0
 * Copyright 2010-2014, The Titon Project - http://titon.io
 * BSD-2 - https://github.com/titon/toolkit/blob/master/license.md
 */
!function(a){"use strict";Toolkit.TypeAhead=Toolkit.Component.extend(function(b,c){if(b=a(b),"input"!==b.prop("tagName").toLowerCase())throw new Error("TypeAhead must be initialized on an input field");b.attr("autocomplete","off"),this.component="TypeAhead",this.version="1.1.0",this.options=c=this.setOptions(c,b),this.element=this.createElement(),this.input=b,this.shadow=null,this.index=-1,this.items=[],this.term="",this.timer=null,this.cache={};var d=this;if(a.each({sorter:"sort",matcher:"match",builder:"build"},function(b,e){if(c[b]!==!1){var f;f=null===c[b]||"function"!==a.type(c[b])?d[e]:c[b],c[b]=f.bind(d)}}),c.prefetch&&"string"===a.type(c.source)){var e=c.source;a.getJSON(e,c.query,function(a){d.cache[e]=a})}c.shadow&&(this.wrapper=a("<div/>").addClass(Toolkit.options.vendor+"type-ahead-shadow"),this.shadow=this.input.clone().addClass(Toolkit.options.isPrefix+"shadow").removeAttr("id").prop("readonly",!0),this.input.addClass("not-shadow").replaceWith(this.wrapper),this.wrapper.append(this.input).append(this.shadow)),this.events={"keyup input":"onLookup","keydown input":"onCycle","clickout element":"hide"},this.enable(),this.fireEvent("init")},{build:function(b){var c=Toolkit.options.vendor,d=a("<a/>",{href:"javascript:;"});return d.append(a("<span/>",{"class":c+"type-ahead-title",html:this.highlight(b.title)})),b.description&&d.append(a("<span/>",{"class":c+"type-ahead-desc",html:b.description})),d},hide:function(){this.shadow&&this.shadow.val(""),this.element.is(":shown")&&(this.element.conceal(),this.fireEvent("hide"))},highlight:function(a){for(var b,c=this.term.replace(/[\-\[\]\{\}()*+?.,\\^$|#]/g,"\\$&").split(" "),d=function(a){return'<mark class="'+Toolkit.options.vendor+'type-ahead-highlight">'+a+"</mark>"},e=0;b=c[e];e++)a=a.replace(new RegExp(b,"ig"),d);return a},lookup:function(a){this.term=a,this.timer=setTimeout(this.onFind.bind(this),this.options.throttle)},match:function(a,b){return a.toLowerCase().indexOf(b.toLowerCase())>=0},position:function(){if(!this.items.length)return void this.hide();var a=this.input.offset();this.element.css({left:a.left,top:a.top+this.input.outerHeight()}).reveal(),this.fireEvent("show")},process:function(b){if(!this.term.length||!b.length)return void this.hide();var c,d=this.options,e={_empty_:[]},f=a("<ul/>");this.items=[],this.index=-1,"function"===a.type(d.sorter)&&(b=d.sorter(b)),"function"===a.type(d.matcher)&&(b=b.filter(function(a){return d.matcher(a.title,this.term)}.bind(this)));for(var g=0;c=b[g];g++)c.category?(e[c.category]||(e[c.category]=[]),e[c.category].push(c)):e._empty_.push(c);var h=[],i=0;a.each(e,function(b,e){var g=[];"_empty_"!==b&&(h.push(null),g.push(a("<li/>").addClass(Toolkit.options.vendor+"type-ahead-heading").append(a("<span/>",{text:b}))));for(var j,k=0;(c=e[k])&&!(i>=d.itemLimit);k++)j=d.builder(c),j.on({mouseover:this.rewind.bind(this),click:a.proxy(this.onSelect,this,h.length)}),g.push(a("<li/>").append(j)),h.push(c),i++;f.append(g)}.bind(this)),this.element.empty(),d.contentElement?this.element.find(d.contentElement).append(f):this.element.append(f),this.items=h,this.cache[this.term.toLowerCase()]=h.filter(function(a){return null!==a}),this.fireEvent("load"),this._shadow(),this.position()},rewind:function(){this.index=-1,this.element.find("li").removeClass(Toolkit.options.isPrefix+"active")},select:function(a,b){this.index=a;var c=this.element.find("li"),d=Toolkit.options.isPrefix;if(c.removeClass(d+"active"),a>=0){if(this.items[a]){var e=this.items[a];c.item(a).addClass(d+"active"),this.input.val(e.title),this.fireEvent(b||"select",[e,a])}}else this.input.val(this.term),this.fireEvent("reset")},sort:function(a){return a.sort(function(a,b){return a.title.localeCompare(b.title)})},_shadow:function(){if(this.shadow){var a=this.input.val(),b=a.toLowerCase(),c="";if(this.cache[b]&&this.cache[b][0]){var d=this.cache[b][0].title;0===d.toLowerCase().indexOf(b)&&(c=a+d.substr(a.length,d.length-a.length))}this.shadow.val(c)}},onCycle:function(a){var b=this.items,c=Math.min(this.options.itemLimit,Math.max(0,b.length));if(c&&this.element.is(":shown")){switch(a.keyCode){case 38:this.index-=b[this.index-1]?1:2,this.index<0&&(this.index=c);break;case 40:this.index+=b[this.index+1]?1:2,this.index>=c&&(this.index=-1);break;case 9:a.preventDefault();for(var d=0;!this.items[d];)d++;this.index=d,this.hide();break;case 13:this.hide();break;case 27:this.index=-1,this.hide();break;default:return}this.shadow&&this.shadow.val(""),this.select(this.index)}},onFind:function(){var b=this.term,c=this.options,d=a.type(c.source);if(this.cache[b.toLowerCase()])this.process(this.cache[b.toLowerCase()]);else if("string"===d){var e=c.source,f=this.cache[e];if(f)this.process(f);else{var g=c.query;g.term=b,a.getJSON(e,g,this.process.bind(this))}}else if("array"===d)this.process(c.source);else{if("function"!==d)throw new Error("Invalid TypeAhead source type");var h=c.source.call(this);h&&this.process(h)}},onLookup:function(b){if(!(a.inArray(b.keyCode,[38,40,27,9,13])>=0)){clearTimeout(this.timer);var c=this.input.val().trim();c.length<this.options.minLength?(this.fireEvent("reset"),this.hide()):(this._shadow(),this.lookup(c))}},onSelect:function(a){this.select(a),this.hide()}},{source:[],minLength:1,itemLimit:15,throttle:250,prefetch:!1,shadow:!1,storage:"session",query:{},contentElement:"",template:'<div class="type-ahead"></div>',sorter:null,matcher:null,builder:null}),Toolkit.createComponent("typeAhead",function(a){return new Toolkit.TypeAhead(this,a)})}(jQuery);