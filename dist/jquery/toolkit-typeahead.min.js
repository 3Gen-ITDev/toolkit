/*!
 * Titon Toolkit v1.0.0
 * Copyright 2010-2013, The Titon Project - http://titon.io
 * BSD-2 - https://github.com/titon/toolkit/blob/master/license.md
 */
!function(a){"use strict";Toolkit.TypeAhead=Toolkit.Component.create(function(b,c){this.options=this.setOptions(Toolkit.TypeAhead.options,c),this.element=this.createElement(this.options),this.input=a(b),this.shadow=null,this.index=-1,this.items=[],this.term="",this.timer=null,this.cache={},this.enabled=!0,this.initialize=function(){if("input"!==this.input.prop("tagName").toLowerCase())throw new Error("TypeAhead must be initialized on an input field");this.input.attr("autocomplete","off");var b=this.options;if(a.each({sorter:"sort",matcher:"match",builder:"build"},function(c,d){if(b[c]!==!1){var e;e=null===b[c]||"function"!==a.type(b[c])?this[d]:b[c],this.options[c]=e.bind(this)}}.bind(this)),b.prefetch&&"string"===a.type(b.source)){var c=b.source;a.ajax({url:c,data:b.query,dataType:"json",success:function(a){this.cache[c]=a}.bind(this)})}b.shadow&&(this.wrapper=a("<div/>").addClass(Toolkit.options.vendor+"type-ahead-shadow"),this.shadow=this.input.clone().addClass(Toolkit.options.isPrefix+"shadow").removeAttr("id").prop("readonly",!0),this.input.addClass("not-shadow").replaceWith(this.wrapper),this.wrapper.append(this.input).append(this.shadow)),this.input.on({keyup:this.__lookup.bind(this),keydown:this.__cycle.bind(this)}),a(window).on("keydown",function(a){27===a.keyCode&&this.element.is(":shown")&&this.hide()}.bind(this)).on("click",this.hide.bind(this)),this.fireEvent("init")},this.build=function(b){var c=a("<a/>",{href:"javascript:;"});return c.append(a("<span/>",{"class":Toolkit.options.vendor+"type-ahead-title",html:this.highlight(b.title)})),b.description&&c.append(a("<span/>",{"class":Toolkit.options.vendor+"type-ahead-desc",html:b.description})),c},this.hide=function(){return this.shadow&&this.shadow.val(""),this.element.is(":shown")&&(this.element.conceal(),this.fireEvent("hide")),this},this.highlight=function(a){for(var b,c=this.term.replace(/[\-\[\]\{\}()*+?.,\\^$|#]/g,"\\$&").split(" "),d=function(a){return'<span class="'+Toolkit.options.vendor+'type-ahead-highlight">'+a+"</span>"},e=0;b=c[e];e++)a=a.replace(new RegExp(b,"ig"),d);return a},this.lookup=function(b){return this.term=b,this.timer=window.setTimeout(function(){var c=this.options,d=a.type(c.source);if(this.cache[b.toLowerCase()])this.process(this.cache[b.toLowerCase()]);else if("string"===d){var e=c.source,f=this.cache[e];if(f)this.process(f);else{var g=c.query;g.term=b,a.ajax({url:e,data:g,dataType:"json",success:this.process.bind(this)})}}else if("array"===d)this.process(c.source);else{if("function"!==d)throw new Error("Invalid TypeAhead source type");var h=c.source.call(this);h&&this.process(h)}}.bind(this),this.options.throttle),this},this.match=function(a,b){return a.toLowerCase().indexOf(b.toLowerCase())>=0},this.position=function(){if(!this.items.length)return this.hide();var a=this.input.offset();return this.element.css({left:a.left,top:a.top+this.input.outerHeight()}).reveal(),this},this.process=function(b){if(!this.term.length||!b.length)return this.hide(),this;var c,d=this.options,e={_empty_:[]},f=a("<ul/>");this.items=[],this.index=-1,"function"===a.type(d.sorter)&&(b=d.sorter(b)),"function"===a.type(d.matcher)&&(b=b.filter(function(a){return d.matcher(a.title,this.term)}.bind(this)));for(var g=0;c=b[g];g++)c.category?(e[c.category]||(e[c.category]=[]),e[c.category].push(c)):e._empty_.push(c);var h=[],i=0;return a.each(e,function(b,e){var g=[];"_empty_"!==b&&(h.push(null),g.push(a("<li/>").addClass(Toolkit.options.vendor+"type-ahead-heading").append(a("<span/>",{text:b}))));for(var j,k=0;(c=e[k])&&!(i>=d.itemLimit);k++)j=d.builder(c),j.on({mouseover:this.rewind.bind(this),click:a.proxy(this.__select,this,h.length)}),g.push(a("<li/>").append(j)),h.push(c),i++;f.append(g)}.bind(this)),this.element.empty(),d.contentElement?this.element.find(d.contentElement).append(f):this.element.append(f),this.items=h,this.cache[this.term.toLowerCase()]=h.filter(function(a){return null!==a}),this.fireEvent("load"),this._shadow(),this.position(),this.fireEvent("show"),this},this.rewind=function(){return this.index=-1,this.element.find("li").removeClass(Toolkit.options.isPrefix+"active"),this},this.select=function(a){this.index=a;var b=this.element.find("li");if(b.removeClass(Toolkit.options.isPrefix+"active"),a>=0){if(this.items[a]){var c=this.items[a];b.item(a).addClass(Toolkit.options.isPrefix+"active"),this.input.val(c.title),this.fireEvent("select",[c,a])}}else this.input.val(this.term),this.fireEvent("reset");return this},this.sort=function(a){return a.sort(function(a,b){return a.title.localeCompare(b.title)})},this._shadow=function(){if(this.shadow){var a=this.input.val(),b=a.toLowerCase(),c="";if(this.cache[b]&&this.cache[b][0]){var d=this.cache[b][0].title;0===d.toLowerCase().indexOf(b)&&(c=a+d.substr(a.length,d.length-a.length))}this.shadow.val(c)}},this.__cycle=function(a){var b=this.items,c=Math.min(this.options.itemLimit,Math.max(0,b.length));if(c&&this.element.is(":shown")){switch(a.keyCode){case 38:this.index-=b[this.index-1]?1:2,this.index<0&&(this.index=c);break;case 40:this.index+=b[this.index+1]?1:2,this.index>=c&&(this.index=-1);break;case 9:a.preventDefault();for(var d=0;!this.items[d];)d++;this.index=d,this.hide();break;case 13:this.hide();break;case 27:this.index=-1,this.hide();break;default:return}this.shadow&&this.shadow.val(""),this.select(this.index)}},this.__lookup=function(b){if(!(a.inArray(b.keyCode,[38,40,27,9,13])>=0)){window.clearTimeout(this.timer);var c=this.input.val().trim();c.length<this.options.minLength?(this.fireEvent("reset"),this.hide()):(this._shadow(),this.lookup(c))}},this.__select=function(a){this.select(a),this.hide()},this.input.length&&this.initialize()}),Toolkit.TypeAhead.options={className:"",source:[],minLength:1,itemLimit:15,throttle:250,prefetch:!1,shadow:!1,storage:"session",query:{},contentElement:"",template:'<div class="type-ahead"></div>',sorter:null,matcher:null,builder:null},a.fn.typeAhead=function(b){return this.each(function(){a(this).addData("toolkit.typeahead",function(){return new Toolkit.TypeAhead(this,b)})})}}(jQuery);