/*!
 * Titon Toolkit v1.0.2
 * Copyright 2010-2013, The Titon Project - http://titon.io
 * BSD-2 - https://github.com/titon/toolkit/blob/master/license.md
 */
!function(){"use strict";Toolkit.Stalker=new Class({Extends:Toolkit.Component,Binds:["__scroll"],target:null,targets:[],marker:null,markers:[],offsets:[],options:{target:"",marker:"",threshold:50,throttle:50,onlyWithin:!0,applyToParent:!0,onScroll:null,onActivate:null,onDeactivate:null},initialize:function(a,b){this.parent(b),this.setElement(a),this.element&&this.options.target&&this.options.marker&&(this.element.addClass(Toolkit.options.vendor+"stalker"),this.refresh(),this.bindEvents(),this.fireEvent("init"))},activate:function(a,b){this.marker=a,this.target=b;var c=this.targets;return this.options.applyToParent?(c.getParent().removeClass(Toolkit.options.isPrefix+"active"),b.getParent().addClass(Toolkit.options.isPrefix+"active")):(c.removeClass(Toolkit.options.isPrefix+"active"),b.addClass(Toolkit.options.isPrefix+"active")),this.fireEvent("activate",[a,b]),this},bindEvents:function(){return("auto"===this.element.getStyle("overflow")?this.element:window).addEvent("scroll:throttle("+this.options.throttle+")",this.__scroll),window.addEvent("domready",this.__scroll),this},deactivate:function(a){var b=this.targets;return this.options.applyToParent?b.getParent().removeClass(Toolkit.options.isPrefix+"active"):b.removeClass(Toolkit.options.isPrefix+"active"),this.marker=null,this.target=null,this.fireEvent("deactivate",a),this},refresh:function(){return"auto"===this.element.getStyle("overflow")&&this.element!==document.body&&(this.element.scrollTop=0),this.target=null,this.targets=$$(this.options.target),this.targets.addClass(Toolkit.options.vendor+"stalker-target"),this.marker=null,this.markers=$$(this.options.marker),this.markers.addClass(Toolkit.options.vendor+"stalker-marker"),this.offsets=this.markers.getCoordinates(this.element),this},__scroll:function(){if(this.enabled){var a=this.element.getScroll().y,b=this.markers,c=this.targets,d=this.offsets,e=this.options.onlyWithin,f=this.options.threshold;b.each(function(b,g){var h=d[g],i=h.top-f,j=h.top+h.height+f,k=[];e&&a>=i&&j>=a||!e&&a>=i?(k=c.filter(function(a){return a.get("href")==="#"+b.get("id")}),k.length&&this.activate(b,k[0])):this.marker===b&&this.deactivate(b)}.bind(this)),this.fireEvent("scroll")}}}),Element.implement("stalker",function(a){return this.$stalker||(this.$stalker=new Toolkit.Stalker(this,a)),this})}();