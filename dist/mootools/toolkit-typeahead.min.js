/*!
 * Titon Toolkit v1.1.0-alpha
 * Copyright 2010-2013, The Titon Project - http://titon.io
 * BSD-2 - https://github.com/titon/toolkit/blob/master/license.md
 */
!function(){"use strict";Toolkit.TypeAhead=new Class({Extends:Toolkit.Component,Implements:[Cache],Binds:["process","rewind","__cycle","__lookup"],input:null,shadow:null,index:-1,items:[],term:"",timer:null,options:{source:[],minLength:1,itemLimit:15,throttle:250,prefetch:!1,shadow:!1,storage:"session",query:{},contentElement:"",template:'<div class="type-ahead"></div>',sorter:null,matcher:null,builder:null,onSelect:null,onCycle:null,onReset:null},initialize:function(a,b){if(this.parent(b),this.createElement(),this.input=a,"input"!==this.input.get("tag"))throw new Error("TypeAhead must be initialized on an input field");if(this.input.set("autocomplete","off"),b=this.options,this.setStorage(b.storage),Object.each({sorter:"sort",matcher:"match",builder:"build"},function(a,c){if(b[c]!==!1){var d;d=null===b[c]||"function"!==typeOf(b[c])?this[a]:b[c],this.options[c]=d.bind(this)}}.bind(this)),b.prefetch&&"string"===typeOf(b.source)){var c=b.source;new Request.JSON({url:c,data:b.query,onSuccess:function(a){this.setCache(c,a)}.bind(this)}).get()}b.shadow&&(this.node=new Element("div."+Toolkit.options.vendor+"type-ahead-shadow").wraps(this.input),this.shadow=this.input.clone().addClass(Toolkit.options.isPrefix+"shadow").removeProperty("id").set("readonly",!0).inject(this.node,"bottom"),this.input.addClass("not-shadow")),this.bindEvents(),this.fireEvent("init")},bindEvents:function(){return window.addEvent("keydown",function(a){"esc"===a.key&&this.isVisible()&&this.hide()}.bind(this)),this.element.addEvent("clickout",this.hide.bind(this)),this.input.addEvents({keyup:this.__lookup,keydown:this.__cycle}),this},build:function(a){var b=new Element("a",{href:"javascript:;"});return b.grab(new Element("span."+Toolkit.options.vendor+"type-ahead-title",{html:this.highlight(a.title)})),a.description&&b.grab(new Element("span."+Toolkit.options.vendor+"type-ahead-desc",{html:a.description})),b},hide:function(){return this.shadow&&this.shadow.set("value",""),this.parent()},highlight:function(a){for(var b,c=this.term.replace(/[\-\[\]\{\}()*+?.,\\^$|#]/g,"\\$&").split(" "),d=function(a){return'<span class="'+Toolkit.options.vendor+'type-ahead-highlight">'+a+"</span>"},e=0;b=c[e];e++)a=a.replace(new RegExp(b,"ig"),d);return a},lookup:function(a){return this.term=a,this.timer=window.setTimeout(function(){var b=this.options,c=typeOf(b.source);if(this.cache[a.toLowerCase()])this.process(this.cache[a.toLowerCase()]);else if("string"===c){var d=b.source,e=this.getCache(d);if(e)this.process(e);else{var f=b.query;f.term=a,new Request.JSON({url:d,data:f,onSuccess:this.process}).get()}}else if("array"===c)this.process(b.source);else{if("function"!==c)throw new Error("Invalid TypeAhead source type");var g=b.source.attempt([],this);g&&this.process(g)}}.bind(this),this.options.throttle),this},match:function(a,b){return a.toLowerCase().indexOf(b.toLowerCase())>=0},position:function(){if(!this.items.length)return this.hide();var a=this.input.getCoordinates();return this.element.setPosition({x:a.left,y:a.top+a.height}),this.element.reveal(),this},process:function(a){if(!this.term.length||!a.length)return this.hide(),this;var b,c=this.options,d={_empty_:[]},e=new Element("ul");this.items=[],this.index=-1,"function"===typeOf(c.sorter)&&(a=c.sorter(a)),"function"===typeOf(c.matcher)&&(a=a.filter(function(a){return c.matcher(a.title,this.term)}.bind(this)));for(var f=0;b=a[f];f++)b.category?(d[b.category]||(d[b.category]=[]),d[b.category].push(b)):d._empty_.push(b);var g=[],h=0;return Object.each(d,function(a,d){var f=new Elements;"_empty_"!==d&&(g.push(null),f.push(new Element("li").addClass(Toolkit.options.vendor+"type-ahead-heading").grab(new Element("span",{text:d}))));for(var i,j=0;(b=a[j])&&!(h>=c.itemLimit);j++)i=c.builder(b),i.addEvents({mouseover:this.rewind,click:this.__select.pass(g.length,this)}),f.push(new Element("li").grab(i)),g.push(b),h++;f.inject(e)}.bind(this)),this.element.empty(),c.contentElement?this.element.getElement(c.contentElement).grab(e):this.element.grab(e),this.items=g,this.cache[this.term.toLowerCase()]=g.filter(function(a){return null!==a}),this.fireEvent("load"),this._shadow(),this.position(),this.fireEvent("show"),this},rewind:function(){return this.index=-1,this.element.getElements("li").removeClass(Toolkit.options.isPrefix+"active"),this},select:function(a,b){this.index=a;var c=this.element.getElements("li");if(c.removeClass(Toolkit.options.isPrefix+"active"),a>=0){if(this.items[a]){var d=this.items[a];c[a].addClass(Toolkit.options.isPrefix+"active"),this.input.set("value",d.title),this.fireEvent(b||"select",[d,a])}}else this.input.set("value",this.term),this.fireEvent("reset");return this},sort:function(a){return a.sort(function(a,b){return a.title.localeCompare(b.title)})},_shadow:function(){if(!this.shadow)return this;var a=this.input.get("value"),b=a.toLowerCase(),c="";if(this.cache[b]&&this.cache[b][0]){var d=this.cache[b][0].title;0===d.toLowerCase().indexOf(b)&&(c=a+d.substr(a.length,d.length-a.length))}return this.shadow.set("value",c),this}.protect(),__cycle:function(a){var b=this.items,c=b.length.limit(0,this.options.itemLimit);if(c&&this.isVisible()){switch(a.key){case"up":this.index-=b[this.index-1]?1:2,this.index<0&&(this.index=c);break;case"down":this.index+=b[this.index+1]?1:2,this.index>=c&&(this.index=-1);break;case"tab":a.preventDefault();for(var d=0;!this.items[d];)d++;this.index=d,this.hide();break;case"enter":this.hide();break;case"esc":this.index=-1,this.hide();break;default:return}this.shadow&&this.shadow.set("value",""),this.select(this.index,"cycle")}},__lookup:function(a){if(!["up","down","esc","tab","enter"].contains(a.key)){window.clearTimeout(this.timer);var b=this.input.get("value").trim();b.length<this.options.minLength?(this.fireEvent("reset"),this.hide()):(this._shadow(),this.lookup(b))}},__select:function(a){this.select(a),this.hide()}}),Element.implement("typeAhead",function(a){return this.$typeAhead||(this.$typeAhead=new Toolkit.TypeAhead(this,a)),this})}();