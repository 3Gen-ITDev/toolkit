/*!
 * Titon Toolkit v1.0.0
 * Copyright 2010-2013, The Titon Project - http://titon.io
 * BSD-2 - https://github.com/titon/toolkit/blob/master/license.md
 */
!function(){"use strict";Toolkit.Flyout=new Class({Extends:Toolkit.Component,Implements:[Timers],current:null,menus:{},data:[],dataMap:{},options:{delegate:".js-flyout",mode:"hover",getUrl:"href",xOffset:0,yOffset:0,showDelay:350,hideDelay:1e3,itemLimit:15,contentElement:".flyout",template:'<div class="flyout"></div>',onHideChild:null,onShowChild:null},initialize:function(a,b,c){if(this.parent(c),this.setNodes(a),!b)throw new Error("Flyout URL required to download sitemap JSON");new Request.JSON({url:b,secure:!0,onSuccess:this.load.bind(this)}).get(),this.addTimers({show:this.position,hide:this.__hide}),c=this.options,"hover"===c.mode&&$(c.context||document.body).addEvent("mouseenter:relay("+c.delegate+")",function(){this.clearTimer("hide").startTimer("show",c.showDelay)}.bind(this)).addEvent("mouseleave:relay("+c.delegate+")",function(){this.clearTimer("show").startTimer("hide",c.showDelay)}.bind(this)),this.bindEvents(),this.fireEvent("init")},hide:function(){return this.clearTimers(),this.node.removeClass(Toolkit.options.isPrefix+"active"),this.current&&this.isVisible()?(this.menus[this.current].conceal(),this.fireEvent("hide"),this.current=null,this):this},isVisible:function(){return this.current&&this.menus[this.current]&&(this.element=this.menus[this.current]),this.parent()},load:function(a,b){if(b=b||0,0===b&&(this.data=a),this.dataMap[a.url]=a,a.children)for(var c=0,d=a.children.length;d>c;c++)this.load(a.children[c],b+1);return this},position:function(){var a=this.current,b=this.options;if(!this.menus[a])return this;var c=this.menus[a],d=c.getDimensions().height,e=this.node.getCoordinates(),f=e.left+b.xOffset,g=e.top+b.yOffset+e.height,h=window.getScrollSize();return g>h.y/2&&(g=e.top-b.yOffset-d),c.setPosition({x:f,y:g}).reveal(),this.fireEvent("show"),this},show:function(a){var b=this._getTarget(a);return this.current&&b!==this.current&&(this.hide(),this.startTimer("show",this.options.showDelay)),this.node=a,this._getMenu()?(this.fireEvent("load",a),this.node.addClass(Toolkit.options.isPrefix+"active"),"click"===this.options.mode&&this.position(),this):this},_buildMenu:function(a,b){if(!b.children||!b.children.length)return null;var c,d,e,f=this.parseTemplate(this.options.template),g=[],h=this.options.contentElement,i=this.options.itemLimit;this.options.className&&f.addClass(this.options.className),a===document.body&&f.addClass(Toolkit.options.isPrefix+"root"),i&&b.children.length>i?g=b.children.chunk(i):g.push(b.children);for(var j,k=0;j=g[k];k++){c=new Element("ul");for(var l,m=0,n=j.length;n>m;m++)l=j[m],d=new Element("li"),l.url?(e=new Element("a",{text:l.title,href:l.url}),new Element("span").addClass(l.icon||"caret-right").inject(e,"top")):(e=new Element("span",{text:l.title}),d.addClass(Toolkit.options.vendor+"flyout-heading")),l.attributes&&e.set(l.attributes),l.className&&d.addClass(l.className),d.grab(e).inject(c),l.children&&l.children.length&&(this._buildMenu(d,l),d.addClass(Toolkit.options.hasPrefix+"children").addEvent("mouseenter",this.__positionChild.bind(this,d)).addEvent("mouseleave",this.__hideChild.bind(this,d)));h?"."===h.substr(0,1)&&f.hasClass(h.substr(1))?f.grab(c):f.getElement(h).grab(c):f.grab(c)}return f.inject(a),f}.protect(),_getMenu:function(){var a=this._getTarget();if(this.menus[a])return this.current=a,this.menus[a];if(this.dataMap[a]){var b=this._buildMenu(document.body,this.dataMap[a]);return b?(b.conceal(),"hover"===this.options.mode&&b.addEvents({mouseenter:function(){this.clearTimer("hide")}.bind(this),mouseleave:function(){this.startTimer("hide",this.options.hideDelay)}.bind(this)}),this.current=a,this.menus[a]=b,this.menus[a]):null}return null}.protect(),_getTarget:function(a){return a=a||this.node,this.readValue(a,this.options.getUrl)||a.get("href")}.protect(),__hideChild:function(a){a.removeClass(Toolkit.options.isPrefix+"open"),a.getChildren(this.options.contentElement).removeProperty("style"),this.fireEvent("hideChild",a)},__positionChild:function(a){var b=a.getElement(this.options.contentElement);if(b){var c=b.getChildren("ul");b.setStyle("width",c.getWidth()[0]*c.length+"px");var d=window.getScrollSize(),e=window.getCoordinates(),f=a.getCoordinates(),g=b.getCoordinates(),h=f.right+g.width;h>=e.width?b.addClass("push-left"):b.removeClass("push-left"),f.top>d.y/2?b.setStyle("top","-"+(g.height-f.height)+"px"):b.setStyle("top",0),a.addClass(Toolkit.options.isPrefix+"open"),this.fireEvent("showChild",a)}}}),Elements.implement("flyout",function(a,b){var c=new Toolkit.Flyout(this,a,b);return this.each(function(a){a.$flyout||(a.$flyout=c)})})}();