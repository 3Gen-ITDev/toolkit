/*!
 * Titon Toolkit v1.0.3
 * Copyright 2010-2013, The Titon Project - http://titon.io
 * BSD-2 - https://github.com/titon/toolkit/blob/master/license.md
 */
!function(){"use strict";Toolkit.Matrix=new Class({Extends:Toolkit.Component,Binds:["__resize","__load"],items:[],matrix:[],wrapperWidth:0,colWidth:0,colCount:0,images:[],imagesLoaded:0,options:{selector:".matrix-item",width:200,gutter:20,rtl:!1,defer:!0,template:!1,onRender:null},initialize:function(a,b){this.parent(b),this.setElement(a),this.element.addClass(Toolkit.options.vendor+"matrix"),this.items=this.element.getElements(this.options.selector),window.addEvent("resize",this.__resize.debounce()),this.fireEvent("init"),this.options.defer?this._deferRender():this.render()},append:function(a){return"element"!==typeOf(a)?this:(a.addClass(Toolkit.options.vendor+"matrix-item").inject(this.element,"bottom").setStyle("opacity",0),this.refresh())},disable:function(){return this.element.removeProperty("style"),this.items.removeClass(Toolkit.options.vendor+"matrix-item").removeProperty("style"),this},enable:function(){return this.items.addClass(Toolkit.options.vendor+"matrix-item"),this},prepend:function(a){return"element"!==typeOf(a)?this:(a.addClass(Toolkit.options.vendor+"matrix-item").inject(this.element,"top").setStyle("opacity",0),this.refresh())},refresh:function(){return this.items=this.element.getElements(this.options.selector),this.render()},remove:function(a){return this.items.every(function(b){return b===a?(b.destroy(),!1):!0}),this.refresh()},render:function(){return this._calculateColumns(),this.items.length<this.colCount?this.disable():(this.enable(),this.colCount<=1?(this.element.addClass("no-columns"),this.items.removeProperty("style")):(this.element.removeClass("no-columns"),this._organizeItems(),this._positionItems()),this.fireEvent("render"),this)},_calculateColumns:function(){var a,b=this.element.getSize().x,c=this.options.width,d=this.options.gutter,e=Math.max(Math.floor(b/c),1),f=e*(c+d)-d;return e>1&&(f>b?(a=f-b,c-=a/e):b>f&&(a=b-f,c+=a/e)),this.wrapperWidth=b,this.colWidth=c,this.colCount=e,this}.protect(),_deferRender:function(){return this.imagesLoaded=0,this.images=this.element.getElements("img"),this.images.length?this.images.each(function(a){var b=a.src;a.onload=this.__load,a.onerror=this.__load,a.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",a.src=b},this):this.render(),this}.protect(),_organizeItems:function(){var a,b,c,d=0,e=this.items.length;this.matrix=[];for(var f=0;e>f;f++){if(a=this.items[f],c=a.getSize(),b=Math.max(Math.round(c.x/this.colWidth),1),this.matrix.push({item:a,span:b}),b>1)for(var g=1;b>g;g++)d++,this.matrix&&this.matrix.push({item:a,span:!1});d++,d>=this.colCount&&(d=0)}return this}.protect(),_positionItems:function(){var a,b,c,d,e,f,g=this.options.gutter,h=this.matrix,i=this.options.rtl?"right":"left",j=0,k=[],l=0,m={margin:0,position:"absolute"};for(d=0;d<this.colCount;d++)k.push(0);for(d=0,e=h.length;e>d;d++){if(a=h[d],b=a.span,(l>=this.colCount||b+l>this.colCount)&&(l=0,j=0),b){for(c=0,f=0;b>f;f++)k[l+f]>c&&(c=k[l+f]);for(m.top=c,m[i]=j,m.width=(this.colWidth+g)*b-g,a.item.setStyles(m).reveal(),f=0;b>f;f++)k[l+f]=a.item.getSize().y+g+c}j+=this.colWidth+g,l++}return this.element.setStyle("height",Math.max.apply(Math,k)),this}.protect(),__load:function(a){(!a||"load"===a.type&&a.target.complete||"error"===a.type&&!a.target.complete)&&this.imagesLoaded++,this.imagesLoaded===this.images.length&&this.render()},__resize:function(){this.element.hasClass(Toolkit.options.vendor+"matrix")&&this.refresh()}}),Element.implement("matrix",function(a){return this.$matrix||(this.$matrix=new Toolkit.Matrix(this,a)),this})}();